<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAN Image Viewer</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="../index.html" class="home-button">Home</a>
            <div class="dropdown">
                <a href="#">Echocardiogram</a>
                <div class="dropdown-content">
                    <a href="./echo.html">GAN</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="#">CMR</a>
                <div class="dropdown-content">
                    <a href="./cmr.html">GAN</a>
                </div>
            </div>
            <div class="dropdown">
                <a href="#">Battery-CT</a>
                <div class="dropdown-content">
                    <a href="./pairgan-battery.html">PairGAN</a>
                    <a href="../segmentation/battery-radial.html">Radial Analysis</a>
                    <a href="../segmentation/battery-axial.html">Axial Analysis</a>
                </div>
            </div>
            <a href="../about/index.html">About</a>
        </div>
    </nav>

    <div class="main-container">
        <div class="introduction">
            <h1>GAN Generated Fake CMR Short Axis Image</h1>
        </div>
        <button onclick="triggerLambda()">Generate</button>
        <div id="images"></div>
    </div>

    <script>
        async function triggerLambda() {
            const apiUrl = "https://8mmd170j86.execute-api.us-east-1.amazonaws.com/staging/gan-output-cmr"; // Replace with your API Gateway URL

            try {
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                if (response.ok) {
                    const responseData = await response.json();
                    console.log("Raw Response Data:", responseData); // Log raw response for debugging

                    // Parse the body
                    const parsedBody = JSON.parse(responseData.body);
                    console.log("Parsed Body:", parsedBody); // Log parsed body for debugging

                    // Extract the prediction field
                    const prediction = parsedBody.prediction[0][0]; // Adjusted for deeper nesting

                    if (!prediction || prediction.length !== 3) {
                        throw new Error("Prediction field is empty or invalid.");
                    }

                    // Clear existing images
                    const imagesDiv = document.getElementById("images");
                    imagesDiv.innerHTML = "";

                    // Rearrange the dimensions from (3, 256, 256) to (256, 256, 3)
                    const height = prediction[0].length;
                    const width = prediction[0][0].length;
                    const rearrangedImage = Array.from({ length: height }, (_, y) =>
                        Array.from({ length: width }, (_, x) => [
                            Math.round((prediction[0][y][x] + 1) * 127.5), // R
                            Math.round((prediction[1][y][x] + 1) * 127.5), // G
                            Math.round((prediction[2][y][x] + 1) * 127.5), // B
                        ])
                    );

                    // Create a canvas element
                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    const context = canvas.getContext("2d");

                    // Create ImageData to draw on the canvas
                    const imgData = context.createImageData(width, height);

                    rearrangedImage.forEach((row, y) => {
                        row.forEach((pixel, x) => {
                            const index = (y * width + x) * 4;
                            imgData.data[index] = pixel[0];     // Red
                            imgData.data[index + 1] = pixel[1]; // Green
                            imgData.data[index + 2] = pixel[2]; // Blue
                            imgData.data[index + 3] = 255;      // Alpha (fully opaque)
                        });
                    });

                    // Draw the ImageData onto the canvas
                    context.putImageData(imgData, 0, 0);

                    // Append the canvas to the imagesDiv
                    imagesDiv.appendChild(canvas);
                } else {
                    alert(`Error: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                alert(`An error occurred: ${error.message}`);
            }
        }
    </script>
</body>
</html>